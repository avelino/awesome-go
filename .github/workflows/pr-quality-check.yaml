name: PR Quality Checks

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  quality:
    name: Repository quality checks
    runs-on: ubuntu-latest
    environment: action
    container: golang:latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Run quality checks
        id: quality
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: go run ./.github/scripts/check-quality/

      - name: Run diff checks
        id: diff
        continue-on-error: true
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
        run: go run ./.github/scripts/check-pr-diff/

      - name: Post quality report comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-quality-check
          message: |
            ${{ steps.quality.outputs.comment }}

            ---

            ${{ steps.diff.outputs.diff_comment }}

      - name: Sync labels
        uses: actions-ecosystem/action-add-labels@v1
        if: ${{ steps.quality.outputs.labels != '' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: ${{ join(fromJson(steps.quality.outputs.labels), '\n') }}

      - name: Fail if critical checks failed
        if: ${{ steps.quality.outputs.fail == 'true' || steps.diff.outputs.diff_fail == 'true' }}
        run: |
          echo "Quality or diff checks failed."
          exit 1

  auto-merge:
    name: Enable auto-merge
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge via squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --auto \
            --squash
